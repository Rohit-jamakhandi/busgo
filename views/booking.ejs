<div class="container mt-4">
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h1 class="h5 mb-0 d-flex align-items-center gap-2">
            <i data-lucide="bus" style="width: 24px; height: 24px;"></i>
            <%= bus.bus_name %>
          </h1>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <div class="d-flex align-items-center gap-2">
                <i data-lucide="map-pin" style="width: 24px; height: 24px; color: #667eea;"></i>
                <div>
                  <small class="text-muted">Route</small>
                  <div class="fw-bold"><%= bus.from %> → <%= bus.to %></div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex align-items-center gap-2">
                <i data-lucide="calendar" style="width: 24px; height: 24px; color: #667eea;"></i>
                <div>
                  <small class="text-muted">Date</small>
                  <div class="fw-bold"><%= bus.date %></div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="d-flex align-items-center gap-2">
                <i data-lucide="clock" style="width: 24px; height: 24px; color: #667eea;"></i>
                <div>
                  <small class="text-muted">Time</small>
                  <div class="fw-bold"><%= bus.time %></div>
                </div>
              </div>
            </div>
          </div>

          <h2 class="h6 mb-3 d-flex align-items-center gap-2" style="color: #667eea;">
            <i data-lucide="layout-grid" style="width: 20px; height: 20px;"></i>
            <span data-i18n="selectSeats">Select Your Seats</span>
          </h2>
          
          <!-- Deck Selection Tabs -->
          <ul class="nav nav-pills mb-3 deck-tabs" id="deckTabs" role="tablist">
            <li class="nav-item flex-fill" role="presentation">
              <button class="nav-link active w-100" id="lower-deck-tab" data-bs-toggle="pill" data-bs-target="#lowerDeck" type="button">
                <i data-lucide="layers" style="width: 16px; height: 16px;"></i>
                Lower Deck
              </button>
            </li>
            <li class="nav-item flex-fill" role="presentation">
              <button class="nav-link w-100" id="upper-deck-tab" data-bs-toggle="pill" data-bs-target="#upperDeck" type="button">
                <i data-lucide="layers" style="width: 16px; height: 16px;"></i>
                Upper Deck
              </button>
            </li>
          </ul>
          
          <div class="tab-content" id="deckTabContent">
            <!-- Lower Deck -->
            <div class="tab-pane fade show active" id="lowerDeck" role="tabpanel">
              <div class="text-center mb-3">
                <div class="driver-section">
                  <i data-lucide="steering-wheel" style="width: 32px; height: 32px; color: #667eea;"></i>
                  <div><small class="text-muted">Driver</small></div>
                </div>
              </div>
              
              <div class="seat-grid-deck">
                <% 
                  const womenSeats = bus.women_seats || [];
                  const lowerDeckSeats = Math.ceil(bus.seats_total / 2);
                  
                  for (let i = 1; i <= lowerDeckSeats; i++) { 
                    const isWomenSeat = womenSeats.includes(i);
                    
                    // Add aisle after every 2 seats
                    if ((i - 1) % 4 === 2) { %>
                      <div class="aisle-space"></div>
                    <% } %>
                    
                    <label class="seat <%= isWomenSeat ? 'women-seat' : '' %>">
                      <input type="checkbox" name="seats" value="<%= i %>" data-women="<%= isWomenSeat %>" />
                      <span><%= i %></span>
                    </label>
                <% } %>
              </div>
            </div>
            
            <!-- Upper Deck -->
            <div class="tab-pane fade" id="upperDeck" role="tabpanel">
              <div class="seat-grid-deck">
                <% 
                  const upperDeckStart = lowerDeckSeats + 1;
                  
                  for (let i = upperDeckStart; i <= bus.seats_total; i++) { 
                    const isWomenSeat = womenSeats.includes(i);
                    
                    // Add aisle after every 2 seats
                    if ((i - upperDeckStart) % 4 === 2) { %>
                      <div class="aisle-space"></div>
                    <% } %>
                    
                    <label class="seat <%= isWomenSeat ? 'women-seat' : '' %>">
                      <input type="checkbox" name="seats" value="<%= i %>" data-women="<%= isWomenSeat %>" />
                      <span><%= i %></span>
                    </label>
                <% } %>
              </div>
            </div>
          </div>
          <div class="seat-legend">
            <div class="legend-item">
              <div class="legend-box" style="background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);"></div>
              <span data-i18n="available">Available</span>
            </div>
            <div class="legend-item">
              <div class="legend-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
              <span data-i18n="selected">Selected</span>
            </div>
            <div class="legend-item">
              <div class="legend-box" style="background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);"></div>
              <span data-i18n="womenOnly">Women Only</span>
            </div>
          </div>

        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card" style="position: sticky; top: 20px;">
        <div class="card-header">
          <h2 class="h6 mb-0" data-i18n="bookingSummary">Booking Summary</h2>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted" data-i18n="farePerSeat">Fare per seat:</span>
              <span class="fw-bold">₹<%= bus.fare %></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted" data-i18n="selectedSeats">Selected seats:</span>
              <span class="fw-bold" id="seatCount">0</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span class="text-muted" data-i18n="seatNumbers">Seat numbers:</span>
              <span class="fw-bold" id="seatNumbers">-</span>
            </div>
            <hr>
            <div class="d-flex justify-content-between">
              <span class="fw-bold" data-i18n="totalAmount">Total Amount:</span>
              <span class="fw-bold" style="color: #667eea; font-size: 1.5rem;">₹<span id="totalAmount">0</span></span>
            </div>
          </div>
          
          <form id="booking-form">
            <input type="hidden" id="busId" value="<%= bus._id %>" />
            <input type="hidden" id="farePerSeat" value="<%= bus.fare %>" />
            
            <button id="submit" class="btn btn-success w-100 btn-lg d-flex align-items-center justify-content-center gap-2">
              <i data-lucide="credit-card" style="width: 20px; height: 20px;"></i>
              <span id="button-text" data-i18n="proceedToPay">Proceed to Pay</span>
              <div class="spinner-border spinner-border-sm d-none" id="spinner"></div>
            </button>
            <div id="booking-message" class="mt-3"></div>
          </form>
          
          <!-- Trust Badges -->
          <div class="trust-badges mt-4 pt-3 border-top">
            <div class="trust-badge">
              <i data-lucide="shield-check" style="width: 20px; height: 20px; color: #28a745;"></i>
              <span data-i18n="securePayment">Secure Payment</span>
            </div>
            <div class="trust-badge">
              <i data-lucide="headphones" style="width: 20px; height: 20px; color: #667eea;"></i>
              <span data-i18n="support247">24x7 Support</span>
            </div>
            <div class="trust-badge">
              <i data-lucide="star" style="width: 20px; height: 20px; color: #ffc107;"></i>
              <span data-i18n="trustedBy">Trusted by 10,000+ travelers</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gender Selection Modal -->
<div class="modal fade" id="genderModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2">
          <i data-lucide="user" style="width: 20px; height: 20px;"></i>
          Select Gender
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p class="text-center mb-3">Seat <strong id="selectedSeatNumber"></strong></p>
        <div class="d-grid gap-3">
          <button class="btn btn-outline-primary btn-lg gender-btn" onclick="selectGender('male')">
            <i data-lucide="user" style="width: 24px; height: 24px; color: #667eea;"></i>
            <span class="ms-2">Male</span>
          </button>
          <button class="btn btn-outline-danger btn-lg gender-btn" onclick="selectGender('female')">
            <i data-lucide="user" style="width: 24px; height: 24px; color: #ff1493;"></i>
            <span class="ms-2">Female</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dummy Payment Gateway Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2">
          <i data-lucide="credit-card" style="width: 24px; height: 24px;"></i>
          Payment Gateway
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <div class="payment-amount">
            <small class="text-muted">Amount to Pay</small>
            <h2 class="text-primary">₹<span id="modalAmount">0</span></h2>
          </div>
        </div>
        
        <!-- Payment Method Tabs -->
        <ul class="nav nav-pills mb-4 payment-tabs" id="paymentTabs" role="tablist">
          <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link active w-100 d-flex align-items-center justify-content-center gap-2" id="card-tab" data-bs-toggle="pill" data-bs-target="#cardPayment" type="button">
              <i data-lucide="credit-card" style="width: 18px; height: 18px;"></i>
              Card
            </button>
          </li>
          <li class="nav-item flex-fill" role="presentation">
            <button class="nav-link w-100 d-flex align-items-center justify-content-center gap-2" id="upi-tab" data-bs-toggle="pill" data-bs-target="#upiPayment" type="button">
              <i data-lucide="smartphone" style="width: 18px; height: 18px;"></i>
              UPI
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="paymentTabContent">
          <!-- Card Payment -->
          <div class="tab-pane fade show active" id="cardPayment" role="tabpanel">
            <form id="payment-gateway-form">
              <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="mb-3">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                  </div>
                </div>
                <div class="col-6">
                  <div class="mb-3">
                    <label class="form-label">CVV</label>
                    <input type="text" class="form-control" id="cvv" placeholder="123" maxlength="3" required>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Cardholder Name</label>
                <input type="text" class="form-control" id="cardholderName" placeholder="John Doe" required>
              </div>
              
              <div class="alert alert-info d-flex align-items-center gap-2">
                <i data-lucide="info" style="width: 20px; height: 20px;"></i>
                <small>This is a demo payment gateway. Any card details will work!</small>
              </div>
              
              <button type="submit" class="btn btn-success w-100 btn-lg d-flex align-items-center justify-content-center gap-2">
                <i data-lucide="lock" style="width: 20px; height: 20px;"></i>
                <span>Pay Securely</span>
                <div class="spinner-border spinner-border-sm d-none" id="paymentSpinner"></div>
              </button>
            </form>
          </div>
          
          <!-- UPI Payment -->
          <div class="tab-pane fade" id="upiPayment" role="tabpanel">
            <form id="upi-payment-form">
              <div class="mb-3">
                <label class="form-label">UPI ID</label>
                <input type="text" class="form-control" id="upiId" placeholder="yourname@paytm / yourname@gpay" required>
                <small class="text-muted">Enter your UPI ID (e.g., 9876543210@paytm)</small>
              </div>
              
              <div class="text-center my-4">
                <div class="upi-apps">
                  <p class="text-muted mb-3">Or pay using</p>
                  <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <div class="upi-app-icon">
                      <div class="upi-icon-circle" style="background: #002970;">
                        <span style="color: white; font-weight: bold; font-size: 0.8rem;">GPay</span>
                      </div>
                    </div>
                    <div class="upi-app-icon">
                      <div class="upi-icon-circle" style="background: #00BAF2;">
                        <span style="color: white; font-weight: bold; font-size: 0.8rem;">Paytm</span>
                      </div>
                    </div>
                    <div class="upi-app-icon">
                      <div class="upi-icon-circle" style="background: #5F259F;">
                        <span style="color: white; font-weight: bold; font-size: 0.8rem;">PhonePe</span>
                      </div>
                    </div>
                    <div class="upi-app-icon">
                      <div class="upi-icon-circle" style="background: #097939;">
                        <span style="color: white; font-weight: bold; font-size: 0.8rem;">BHIM</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="alert alert-info d-flex align-items-center gap-2">
                <i data-lucide="info" style="width: 20px; height: 20px;"></i>
                <small>This is a demo payment. Any UPI ID will work!</small>
              </div>
              
              <button type="submit" class="btn btn-success w-100 btn-lg d-flex align-items-center justify-content-center gap-2">
                <i data-lucide="smartphone" style="width: 20px; height: 20px;"></i>
                <span>Pay with UPI</span>
                <div class="spinner-border spinner-border-sm d-none" id="upiSpinner"></div>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
  // Gender selection tracking
  const seatGenders = {}; // {seatNumber: 'male' or 'female'}
  let currentSeatForGender = null;
  const genderModal = new bootstrap.Modal(document.getElementById('genderModal'));
  
  // Update booking summary
  const farePerSeat = parseInt(document.getElementById('farePerSeat').value);
  const seatCheckboxes = document.querySelectorAll('input[name="seats"]');

  seatCheckboxes.forEach(cb => {
    cb.addEventListener('change', function(e) {
      if (this.checked) {
        // Seat selected - ask for gender
        currentSeatForGender = this.value;
        document.getElementById('selectedSeatNumber').textContent = this.value;
        genderModal.show();
        
        // Refresh icons in modal
        setTimeout(() => {
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        }, 100);
      } else {
        // Seat deselected - remove gender and icon
        delete seatGenders[this.value];
        const seatLabel = this.closest('.seat');
        seatLabel.classList.remove('male-selected', 'female-selected');
        updateSummary();
      }
    });
  });
  
  // Global function for gender selection
  window.selectGender = function(gender) {
    if (currentSeatForGender) {
      seatGenders[currentSeatForGender] = gender;
      
      // Find the seat label and add gender class
      const checkbox = document.querySelector(`input[value="${currentSeatForGender}"]`);
      const seatLabel = checkbox.closest('.seat');
      
      // Remove previous gender classes
      seatLabel.classList.remove('male-selected', 'female-selected');
      
      // Add new gender class
      if (gender === 'male') {
        seatLabel.classList.add('male-selected');
      } else {
        seatLabel.classList.add('female-selected');
      }
      
      genderModal.hide();
      updateSummary();
    }
  };

  function updateSummary() {
    const selected = Array.from(seatCheckboxes).filter(cb => cb.checked);
    const count = selected.length;
    const total = count * farePerSeat;
    const seatNums = selected.map(cb => cb.value).join(', ');
    
    document.getElementById('seatCount').textContent = count;
    document.getElementById('seatNumbers').textContent = seatNums || '-';
    document.getElementById('totalAmount').textContent = total;
  }

  // Handle booking confirmation
  const form = document.getElementById('booking-form');
  const submitBtn = document.getElementById('submit');
  const spinner = document.getElementById('spinner');
  const buttonText = document.getElementById('button-text');
  const messageDiv = document.getElementById('booking-message');
  let selectedSeatsForPayment = [];
  let busIdForPayment = '';

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const busId = document.getElementById('busId').value;
    const seats = Array.from(document.querySelectorAll('input[name="seats"]:checked')).map(cb => parseInt(cb.value));
    
    if (seats.length === 0) {
      showMessage('⚠️ Please select at least one seat before proceeding.', 'warning');
      return;
    }

    // Store for payment modal
    selectedSeatsForPayment = seats;
    busIdForPayment = busId;
    
    // Show payment modal
    const totalAmount = seats.length * farePerSeat;
    document.getElementById('modalAmount').textContent = totalAmount;
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
    paymentModal.show();
    
    // Refresh icons in modal
    setTimeout(() => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }, 100);
  });

  // Handle dummy payment gateway
  const paymentForm = document.getElementById('payment-gateway-form');
  const cardNumberInput = document.getElementById('cardNumber');
  const expiryDateInput = document.getElementById('expiryDate');
  const cvvInput = document.getElementById('cvv');

// Format card number
cardNumberInput.addEventListener('input', (e) => {
  let value = e.target.value.replace(/\s/g, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  e.target.value = formattedValue;
});

// Format expiry date
expiryDateInput.addEventListener('input', (e) => {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + '/' + value.slice(2, 4);
  }
  e.target.value = value;
});

// Only allow numbers in CVV
cvvInput.addEventListener('input', (e) => {
  e.target.value = e.target.value.replace(/\D/g, '');
});

  // Handle card payment
  paymentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await processPayment('paymentSpinner');
  });

  // Handle UPI payment
  const upiForm = document.getElementById('upi-payment-form');
  upiForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    await processPayment('upiSpinner');
  });

  // Common payment processing function
  async function processPayment(spinnerId) {
    const spinner = document.getElementById(spinnerId);
    const paymentBtn = event.target.querySelector('button[type="submit"]');
    
    paymentBtn.disabled = true;
    spinner.classList.remove('d-none');
    
    // Simulate payment processing
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
    
    // Now confirm booking
    setLoading(true);
    showMessage('🔄 Confirming your booking...', 'info');

    try {
      const resp = await fetch('/bookings/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ busId: busIdForPayment, seats: selectedSeatsForPayment })
      });
      const data = await resp.json();
      
      if (resp.status === 401) {
        showMessage('⚠️ Please <a href="/login">login</a> to book tickets.', 'warning');
        setLoading(false);
        return;
      }
      
      if (!resp.ok) throw new Error(data.error || 'Failed to confirm booking');

      // Show success message with download receipt button
      showMessage(`
        <div class="text-center">
          <div style="margin-bottom: 1rem;">
            <i data-lucide="check-circle" style="width: 64px; height: 64px; color: #28a745;"></i>
          </div>
          <h4>Booking Confirmed!</h4>
          <p class="mb-2">Booking ID: <strong>${data.bookingId}</strong></p>
          <p class="mb-3">Seats: <strong>${data.seats.join(', ')}</strong></p>
          <p class="mb-3">Total Amount: <strong>₹${data.amount}</strong></p>
          <div class="d-grid gap-2">
            <a href="/bookings/receipt/${data.bookingId}" class="btn btn-primary d-flex align-items-center justify-content-center gap-2" target="_blank">
              <i data-lucide="file-text" style="width: 18px; height: 18px;"></i>
              Download Receipt
            </a>
            <a href="/bookings/my" class="btn btn-outline-primary">View My Bookings</a>
          </div>
        </div>
      `, 'success');
      setTimeout(() => lucide.createIcons(), 100);
      submitBtn.disabled = true;
      
      // Disable seat selection
      seatCheckboxes.forEach(cb => cb.disabled = true);
    } catch (err) {
      showMessage('❌ Error: ' + err.message, 'danger');
      setLoading(false);
    }
  }

  function showMessage(text, type = 'info') {
    messageDiv.className = `alert alert-${type}`;
    messageDiv.innerHTML = text;
  }

  function setLoading(isLoading) {
    if (isLoading) {
      submitBtn.disabled = true;
      spinner.classList.remove('d-none');
      buttonText.classList.add('d-none');
    } else {
      submitBtn.disabled = false;
      spinner.classList.add('d-none');
      buttonText.classList.remove('d-none');
    }
  }

  // Initialize Lucide icons and trigger initial summary update
  if (typeof lucide !== 'undefined') {
    lucide.createIcons();
  }
  updateSummary(); // Initialize with 0 seats
});
</script>
